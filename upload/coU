import { parse } from 'csv-parse';
import fs from 'fs';
import path from 'path';

const inputFolderPath = process.argv[2]; // Path to the input folder containing CSV files
if (!inputFolderPath) {
  console.error('Usage: node script.js <input_folder_path>');
  process.exit(1);
}

const filteredRecords = [];
let headerProcessed = false;
let rowCount = 0;
let processedFilesCount = 0;

const csvFiles = fs.readdirSync(inputFolderPath).filter(file => file.toLowerCase().endsWith('.csv'));

function processFile(filePath) {
  const parser = parse({
    delimiter: ';',
    columns: true,
    skip_empty_lines: true
  });

  const fileReadStream = fs.createReadStream(filePath);

  parser.on('readable', function () {
    let record;
    while ((record = parser.read()) !== null) {
      if (!headerProcessed) {
        headerProcessed = true;
        filteredRecords.push(Object.keys(record).join(',')); // Add header to filtered data
      }

      if (record['CNAE CODIGO'] == '8650003' && !record['CORREIO ELETRONICO'].includes('TESTE') &&
        !record['CORREIO ELETRONICO'].includes('CONTABIL')) {
        filteredRecords.push(Object.values(record).join(',')); // Add filtered record to filtered data
        rowCount++;
      }
    }
  });

  parser.on('error', function (err) {
    console.error(err.message);
  });

  fileReadStream.pipe(parser);

  parser.on('end', function () {
    console.log(`Processed file: ${filePath}`);
    processedFilesCount++;

    if (processedFilesCount === csvFiles.length) {
      // After processing all files, write the filtered records to output.csv
      const outputFilePath = `output.csv`;
      fs.writeFileSync(outputFilePath, filteredRecords.join('\n'));
      console.log(`Filtered data has been written to ${outputFilePath}.`);
      console.log(`Found ${rowCount} rows matching the filter criteria.`);
    }
  });
}

csvFiles.forEach(file => {
  const inputFilePath = path.join(inputFolderPath, file);
  processFile(inputFilePath);
});
